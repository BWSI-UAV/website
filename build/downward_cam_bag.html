<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Downward Camera Analysis + Line Detection &mdash; Autonomous Air Vehicle Racing 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Autonomous Air Vehicle Racing
          </a>
              <div class="version">
                0.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Course Agenda:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">BWSI’s Autonomous Air Vehicle Racing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Syllabus.html">2024 Course Syllabus*</a></li>
<li class="toctree-l1"><a class="reference internal" href="../initial_setup.html">Module 0: UAV Environment Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quadrotor_basics.html">Module 1: Quadrotor Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../computer_vision.html">Module 2: Computer Vision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Topics:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vim_tutorial.html">Vim Text Editor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exploring_px4_firmware.html">Exploring PX4 Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kalman_filters.html">Kalman Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simulation_challenge.html">Simulation Challenge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_linefollowing_ideas.html">Advanced linefollowing ideas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Supplemental Material:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../team_roles.html">Team Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../safety_checklist.html">Safety Checklist</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Autonomous Air Vehicle Racing</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Downward Camera Analysis + Line Detection</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/build/downward_cam_bag.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Downward-Camera-Analysis-+-Line-Detection">
<h1>Downward Camera Analysis + Line Detection<a class="headerlink" href="#Downward-Camera-Analysis-+-Line-Detection" title="Permalink to this heading"></a></h1>
<p>In this lesson, you will learn about how to analyze the output of the downward-facing camera and use it in your code development for line following.</p>
<section id="Integrating-opencv-and-ROS-images">
<h2>Integrating <code class="docutils literal notranslate"><span class="pre">opencv</span></code> and ROS images<a class="headerlink" href="#Integrating-opencv-and-ROS-images" title="Permalink to this heading"></a></h2>
<p>You will now learn how to use ROS images with <code class="docutils literal notranslate"><span class="pre">opencv</span></code>. The key package you will be using to do so is <code class="docutils literal notranslate"><span class="pre">cv_bridge</span></code>.</p>
<p>The following code is a skeleton node that you will need to complete. In your finished program, you should be able to subscribe to the downward camera and publish a processed image that you should be able to see/verify in <code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code></p>
<p>Copy-paste the following code into a python file and work from there. You will write this program <strong>as a team, on the drone</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">cv_bridge</span> <span class="kn">import</span> <span class="n">CvBridge</span><span class="p">,</span> <span class="n">CvBridgeError</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Starter code for an image processing node. Subscribes to the downward camera</span>
<span class="sd">and publishes a processed cv image (i.e. colorized, overlayed with a detected line)</span>
<span class="sd">This node is not meant to be a full node that you will use in your final line tracking</span>
<span class="sd">solution, but it will teach you key concepts that you will need for line following</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">ImageToCV</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># A subscriber to the topic &#39;/aero_downward_camera/image&#39;. self.image_sub_cb is called when a message is recieved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;/aero_downward_camera/image&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_cb</span><span class="p">)</span>

        <span class="c1"># A publisher which will publish a parametrization of the detected line to the topic &#39;/image_to_cv/processed&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s2">&quot;/image_to_cv/processed&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">CvBridge</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">image_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback function which is called when a new message of type Image is recieved by self.camera_sub.</span>

<span class="sd">            Args:</span>
<span class="sd">                - msg = ROS Image message in 8UC1 format</span>

<span class="sd">            Returns: NA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cv_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;8UC1&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cv_image</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CvBridgeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes in an img param and finds the line in it, if it exists</span>

<span class="sd">            Args:</span>
<span class="sd">                - img : OpenCV Image to process</span>

<span class="sd">            Publishes:</span>
<span class="sd">                - annotated image to the /image_to_cv/processed topic</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;TODO-START: FILL IN CODE HERE&quot;&quot;&quot;</span>
        <span class="c1"># Get a colored copy of the image. This will be used solely to provide an annotated version</span>
        <span class="c1"># of the image for debuging purposes (for you to see in rqt_image_view). See slides for help here</span>

        <span class="c1"># Threshold the image to isolate the line and use it for your linear regression algorithm</span>
        <span class="c1"># (tip: check size to ensure you are detecting the LED line or a simple blip on the screen)</span>

        <span class="c1"># &quot;Draw&quot; a line if you have found one on the image</span>

        <span class="c1"># Publish your newly annotated, color image</span>
        <span class="c1"># NOTE: If you do not detect a line, or if you have decided to ignore detected lines of very small</span>
        <span class="c1">#       size, be sure to still publish the image. Also be sure to have some way to handle the camera</span>
        <span class="c1">#       seeing multiple &quot;lines&quot; at one time</span>


<span class="w">        </span><span class="sd">&quot;&quot;&quot;TODO-END&quot;&quot;&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s2">&quot;image_to_cv&quot;</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ImageToCV</span><span class="p">()</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
</pre></div>
</div>
<section id="Visualization">
<h3>Visualization<a class="headerlink" href="#Visualization" title="Permalink to this heading"></a></h3>
<p>When you have finished writing the program, make sure you make it exectuable (you only need to do this once) using the usual command (<code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">filename.py</span></code>). Do the following to launch your code: Terminal 1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>roscore
</pre></div>
</div>
<p>Terminal 2 (starts optical flow):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo -E bwsi-uav/catkin_ws/src/aero-optical-flow/build/aero-optical-flow
</pre></div>
</div>
<p>Terminal 3 (run your code):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>python filename.py
</pre></div>
</div>
<p>Terminal 4:</p>
<blockquote>
<div><p>Use <code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code> to visualize the resulting images on <code class="docutils literal notranslate"><span class="pre">/image_to_cv/processed</span></code>. If all goes well, you should see an annotated image when viewing this topic in <code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code>, with a contour or a line over where your detected line is. (<em>For reference:</em> your camera feed should look a lot like the images you worked with in the Contour Analysis section of the Downward.ipynb lab.)</p>
</div></blockquote>
</section>
</section>
<section id="Intro-to-rosbags">
<h2>Intro to <code class="docutils literal notranslate"><span class="pre">rosbag</span></code>s<a class="headerlink" href="#Intro-to-rosbags" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">rosbag</span></code> is an ROS tool that allows you to record the output of any number of ROS topics while the drone is in operation. This tool is useful for code development because it means we can test without having a drone flying around all the time. We will be using it to look at the LED strip you will have to follow in this week’s challenge.</p>
<section id="Syntax-of-rosbag-record">
<h3>Syntax of rosbag record<a class="headerlink" href="#Syntax-of-rosbag-record" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">rosbag</span> <span class="pre">record</span> <span class="pre">[options]</span> <span class="pre">/&lt;topicname&gt;</span> <span class="pre">[/&lt;moretopics&gt;...]</span></code></p>
<ul class="simple">
<li><p>Usually, you should use <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">&lt;name&gt;.bag</span></code> for your <code class="docutils literal notranslate"><span class="pre">[option]</span></code>. The <code class="docutils literal notranslate"><span class="pre">-O</span></code> (capital O) flag tells ros that the following argument (formatted <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;.bag</span></code>) is the name we want for our bag file. Otherwise, a default, messy name will be used.</p></li>
<li><p>For this lab’s purpose, you should use this topic for <code class="docutils literal notranslate"><span class="pre">/&lt;topicname&gt;</span></code>: <code class="docutils literal notranslate"><span class="pre">/aero_downward_camera/image</span></code></p></li>
</ul>
</section>
<section id="Recording-a-rosbag">
<h3>Recording a <code class="docutils literal notranslate"><span class="pre">rosbag</span></code><a class="headerlink" href="#Recording-a-rosbag" title="Permalink to this heading"></a></h3>
<p><strong>SSH into the drone.</strong></p>
<p>Terminal 1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>roscore
</pre></div>
</div>
<p>Terminal 2 (starts optical flow):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo -E bwsi-uav/catkin_ws/src/aero-optical-flow/build/aero-optical-flow
</pre></div>
</div>
<p>Terminal 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd ~/rosbags
</pre></div>
</div>
<blockquote>
<div><p>(if the <code class="docutils literal notranslate"><span class="pre">rosbags</span></code> directory doesn’t exist, run <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">~/rosbags</span></code> and then <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">~/rosbags</span></code>)</p>
</div></blockquote>
<p>Now, you will record a bag file. Make sure to use <code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code> on the drone to see what you are recording as you record it. Keep in mind that you will be recording a lot of data in your bag file, even if you are recording only one topic. We will learn later how to record compressed bags, but for now, just remember to <strong>keep your bag recordings relatively short, around 30 seconds maximum</strong> to avoid filling up your storage.</p>
<p>Use this command for today’s lab:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rosbag record -O downward.bag /aero_downward_camera/image
</pre></div>
</div>
<p>When you are finished recording, <code class="docutils literal notranslate"><span class="pre">ctrl-c</span></code> in the window you are recording your bag in to stop it.</p>
</section>
</section>
<section id="Getting-your-bag-off-the-drone-for-analysis">
<h2>Getting your bag off the drone for analysis<a class="headerlink" href="#Getting-your-bag-off-the-drone-for-analysis" title="Permalink to this heading"></a></h2>
<p>After recording a bag, especially a long one, your drone storage might be relatively full. If you want, check disk usage with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">df</span> <span class="pre">-h</span> <span class="pre">/</span></code>. We will now transfer the bag file from the drone to your laptop and delete the bag file from the drone to free up space.</p>
<p><strong>On your laptop:</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd ~/Desktop (or other dir in which you want the bagfile to go)
scp uav@&lt;teamname&gt;.beaver.works:~/rosbags/downward.bag ~/&lt;file/path/on_your_laptop&gt;/.
</pre></div>
</div>
<p><strong>On the drone:</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd ~/rosbags
rm downward.bag
</pre></div>
</div>
<p>Your bag should now be on your laptop and deleted off the drone.</p>
</section>
<section id="Playing-your-bag-file">
<h2>Playing your bag file<a class="headerlink" href="#Playing-your-bag-file" title="Permalink to this heading"></a></h2>
<p><strong>On your laptop:</strong></p>
<p>Terminal 1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>roscore
</pre></div>
</div>
<p>Terminal 2:</p>
<blockquote>
<div><p>In the folder where you saved your bag file, use <code class="docutils literal notranslate"><span class="pre">rosbag</span> <span class="pre">play</span> <span class="pre">&lt;filename&gt;.bag</span></code> to “play” the bag file.</p>
</div></blockquote>
<p>Terminal 3:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rqt_image_view
</pre></div>
</div>
<p>If you have completed the above code correctly, you should see an annotated image when you select the <code class="docutils literal notranslate"><span class="pre">/aero_downward_camera/image</span></code> in <code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Beaver Works Summer Institute, Nathaniel Hanson, Kendrick Cancio, Ross Allen, Mark Mazumder.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>