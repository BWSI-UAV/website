

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Downward Camera Recording + Line Detection &mdash; Autonomous UAV Racing 0.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Custom ROS Message for Line Params" href="detector.html" />
    <link rel="prev" title="Coordinate Frames" href="coordinate_transforms.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Autonomous UAV Racing
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Course Agenda:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">BWSI’s Autonomous UAV Racing</a></li>
<li class="toctree-l1"><a class="reference internal" href="initial_setup.html">Module 0: UAV Environment Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="quadrotor_basics.html">Module 1: Hands-On Quadrotors</a></li>
<li class="toctree-l1"><a class="reference internal" href="computer_vision.html">Module 2: Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="planning_control.html">Module 3: Estimation &amp; Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="racing_challenges.html">Module 4: Racing Challenges</a></li>
</ul>
<p class="caption"><span class="caption-text">Practicals:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="project_workflow.html">Project Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="student_drone_setup.html">Student Drone Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="calibration.html">Calibrating Intel RTF Drones</a></li>
<li class="toctree-l1"><a class="reference internal" href="flight_log_analysis.html">Flight Log Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="intel_rtf_architecture.html">Architecture Concept Review</a></li>
<li class="toctree-l1"><a class="reference internal" href="ros_introduction.html">Intro to ROS</a></li>
<li class="toctree-l1"><a class="reference internal" href="communication_pipeline.html">Communication Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessing_video_streams.html">Accessing Video Streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal_sensor_testing.html">Inspecting Sensor Feeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_optical_flow.html">Hovering with Optical Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="coordinate_transforms.html">Coordinate Frames</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Downward Camera Recording + Line Detection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#rosbag-Usage"><code class="docutils literal notranslate"><span class="pre">rosbag</span></code> Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Syntax">Syntax</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Setting-up-for-rosbag">Setting up for <code class="docutils literal notranslate"><span class="pre">rosbag</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Post-bag-Clean-up">Post-bag Clean-up</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Playing-your-bag-file">Playing your bag file</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Syntax">Syntax</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Integrating-opencv-and-ROS-images">Integrating <code class="docutils literal notranslate"><span class="pre">opencv</span></code> and ROS images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Visualization">Visualization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="detector.html">Custom ROS Message for Line Params</a></li>
<li class="toctree-l1"><a class="reference internal" href="open_loop_translation_control.html">OFFBOARD Mode &amp; Open Loop Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="yaw_color_tracker.html">Yaw-Only Color Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="line_following.html">Line Following</a></li>
<li class="toctree-l1"><a class="reference internal" href="obstacle_avoidance.html">AR Obstacle Avoidance</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Topics:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="exploring_px4_firmware.html">Exploring PX4 Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="kalman_filters.html">Kalman Filters</a></li>
</ul>
<p class="caption"><span class="caption-text">Supplemental Material:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="team_roles.html">Team Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="safety_checklist.html">Safety Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="Glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Autonomous UAV Racing</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Downward Camera Recording + Line Detection</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/downward_cam_bag.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Downward-Camera-Recording-+-Line-Detection">
<h1>Downward Camera Recording + Line Detection<a class="headerlink" href="#Downward-Camera-Recording-+-Line-Detection" title="Permalink to this headline">¶</a></h1>
<p>In this document, you will learn about how to record the output of the
downward-facing camera and use it in your code development for line
following.</p>
<div class="section" id="rosbag-Usage">
<h2><code class="docutils literal notranslate"><span class="pre">rosbag</span></code> Usage<a class="headerlink" href="#rosbag-Usage" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">rosbag</span></code> is an ROS tool that allows you to record the output of any
number of ROS topics while the drone is in operation. This tool is
useful for code development because it means we can test without having
a drone flying around all the time. We will be using it to look at the
LED strip you will have to follow in this week’s challenge.</p>
<div class="section" id="Syntax">
<h3>Syntax<a class="headerlink" href="#Syntax" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">rosbag</span> <span class="pre">record</span> <span class="pre">[options]</span> <span class="pre">/&lt;topicname&gt;</span> <span class="pre">[/&lt;moretopics&gt;...]</span></code>
<code class="docutils literal notranslate"><span class="pre">[options]</span></code> should be replaced with <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">&lt;name&gt;.bag</span></code> in most cases.</p>
<p>Topic of interest for line following: <code class="docutils literal notranslate"><span class="pre">/aero_downward_camera/image</span></code></p>
</div>
<div class="section" id="Setting-up-for-rosbag">
<h3>Setting up for <code class="docutils literal notranslate"><span class="pre">rosbag</span></code><a class="headerlink" href="#Setting-up-for-rosbag" title="Permalink to this headline">¶</a></h3>
<p>SSH into the drone, then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">catkin_ws</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">aero</span><span class="o">-</span><span class="n">optical</span><span class="o">-</span><span class="n">flow</span><span class="o">/</span><span class="n">build</span>
<span class="n">sudo</span> <span class="o">-</span><span class="n">E</span> <span class="o">./</span><span class="n">aero</span><span class="o">-</span><span class="n">optical</span><span class="o">-</span><span class="n">flow</span>
<span class="n">cd</span> <span class="o">~/</span><span class="n">rosbags</span>
</pre></div>
</div>
<p>(if this doesn’t exist, <code class="docutils literal notranslate"><span class="pre">mkdir</span> <span class="pre">~/rosbags</span></code> and then <code class="docutils literal notranslate"><span class="pre">cd</span></code>)</p>
<p>Now, you will record the bag file. Make sure to use <code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code>
over SSH (<code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">-Y</span></code> enables this behavior) and <strong>check that the
downward camera is on and over the area of interest before you start
recording!</strong> Also, bag files can get incredibly large when recording
images, so limit recordings to ~30 seconds at a time. <strong>We will enforce
this.</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rosbag</span> <span class="n">record</span> <span class="o">-</span><span class="n">O</span> <span class="n">downward</span><span class="o">.</span><span class="n">bag</span> <span class="o">/</span><span class="n">aero_downward_camera</span><span class="o">/</span><span class="n">image</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Post-bag-Clean-up">
<h2>Post-bag Clean-up<a class="headerlink" href="#Post-bag-Clean-up" title="Permalink to this headline">¶</a></h2>
<p>Check disk usage with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">df</span> <span class="pre">-h</span> <span class="pre">/</span></code>. The disk might be super full at
this point. We will now transfer the bag file from the drone to your
laptop and delete the bag file from the drone.</p>
<p>On your laptop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">Desktop</span> <span class="p">(</span><span class="ow">or</span> <span class="n">other</span> <span class="nb">dir</span><span class="p">)</span>
<span class="n">scp</span> <span class="n">uav</span><span class="o">@&lt;</span><span class="n">teamname</span><span class="o">&gt;.</span><span class="n">beaver</span><span class="o">.</span><span class="n">works</span><span class="p">:</span><span class="o">~/</span><span class="n">rosbags</span><span class="o">/</span><span class="n">downward</span><span class="o">.</span><span class="n">bag</span> <span class="o">~/</span><span class="n">Desktop</span><span class="o">/.</span>
</pre></div>
</div>
<p>On drone (thru SSH):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">rosbags</span>
<span class="n">rm</span> <span class="n">downward</span><span class="o">.</span><span class="n">bag</span>
</pre></div>
</div>
</div>
<div class="section" id="Playing-your-bag-file">
<h2>Playing your bag file<a class="headerlink" href="#Playing-your-bag-file" title="Permalink to this headline">¶</a></h2>
<p>We will now use <code class="docutils literal notranslate"><span class="pre">rosbag</span> <span class="pre">play</span></code> to play back the images you recorded.</p>
<div class="section" id="Syntax">
<h3>Syntax<a class="headerlink" href="#Syntax" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">rosbag</span> <span class="pre">play</span> <span class="pre">/path/to/&lt;filename&gt;.bag</span></code> while <code class="docutils literal notranslate"><span class="pre">roscore</span></code> is running
somewhere <strong>ON YOUR LAPTOP, LOCALLY</strong>. This will begin to play the
images in real time as they were captured on the drone. You can use
<code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code> to visualize them, and you can use them in whatever
line detection code you are working on. Distribute as needed among team
members so that you can work at night, if so desired. Images will be
published on <code class="docutils literal notranslate"><span class="pre">/aero_downward_camera/image</span></code>, as they were on the drone.</p>
</div>
</div>
<div class="section" id="Integrating-opencv-and-ROS-images">
<h2>Integrating <code class="docutils literal notranslate"><span class="pre">opencv</span></code> and ROS images<a class="headerlink" href="#Integrating-opencv-and-ROS-images" title="Permalink to this headline">¶</a></h2>
<p>You will now learn how to use ROS images, like those captured in your
newly minted bag file, with <code class="docutils literal notranslate"><span class="pre">opencv</span></code>. The key package you will be
using to do so is <code class="docutils literal notranslate"><span class="pre">cv_bridge</span></code>. If you do not have <code class="docutils literal notranslate"><span class="pre">cv_bridge</span></code>
installed (which you can check by opening a python shell in Terminal and
typing <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">cv_bridge</span></code>), you can install it using
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">ros-kinetic-cv-bridge</span></code>. The following code shows
an example class that subscribes to the downward camera topic and
creates an <code class="docutils literal notranslate"><span class="pre">opencv</span></code> compatible image. It then “processes” the image
and publishes it on a new ROS topic.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">cv_bridge</span> <span class="kn">import</span> <span class="n">CvBridge</span><span class="p">,</span> <span class="n">CvBridgeError</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">Image</span>


<span class="n">_DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">class</span> <span class="nc">ImageToCV</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;/aero_downward_camera/image&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s2">&quot;/image_to_cv/processed&quot;</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">CvBridge</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">image_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cv_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;bgr8&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">CvBridgeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cv_image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="c1"># cv2 processing goes here</span>

        <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">cv2_to_imgmsg</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s2">&quot;bgr8&quot;</span><span class="p">))</span>

            <span class="k">except</span> <span class="n">CvBridgeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s2">&quot;image_to_cv&quot;</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">ImageToCV</span><span class="p">()</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="Visualization">
<h3>Visualization<a class="headerlink" href="#Visualization" title="Permalink to this headline">¶</a></h3>
<p>You can use <code class="docutils literal notranslate"><span class="pre">rqt_image_view</span></code> to visualize the resulting images on
<code class="docutils literal notranslate"><span class="pre">/image_to_cv/processed</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="detector.html" class="btn btn-neutral float-right" title="Custom ROS Message for Line Params" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="coordinate_transforms.html" class="btn btn-neutral" title="Coordinate Frames" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Ross Allen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>