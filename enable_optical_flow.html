

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Hovering with Optical Flow &mdash; Autonomous UAV Racing 0.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Coordinate Frames" href="coordinate_transforms.html" />
    <link rel="prev" title="Inspecting Sensor Feeds" href="internal_sensor_testing.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Autonomous UAV Racing
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Course Agenda:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">BWSI’s Autonomous UAV Racing</a></li>
<li class="toctree-l1"><a class="reference internal" href="initial_setup.html">Module 0: UAV Environment Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="quadrotor_basics.html">Module 1: Hands-On Quadrotors</a></li>
<li class="toctree-l1"><a class="reference internal" href="computer_vision.html">Module 2: Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="planning_control.html">Module 3: Estimation &amp; Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="racing_challenges.html">Module 4: Racing Challenges</a></li>
</ul>
<p class="caption"><span class="caption-text">Practicals:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="student_drone_setup.html">Student Drone Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="project_workflow.html">Project Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="calibration.html">Calibrating Intel RTF Drones</a></li>
<li class="toctree-l1"><a class="reference internal" href="flight_log_analysis.html">Flight Log Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="intel_rtf_architecture.html">Architecture Concept Review</a></li>
<li class="toctree-l1"><a class="reference internal" href="communication_pipeline.html">Communication Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessing_video_streams.html">Accessing Video Streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal_sensor_testing.html">Inspecting Sensor Feeds</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hovering with Optical Flow</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Step-1:-Install-Libraries">Step 1: Install Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Step-2:-Start-Optical-Flow-Services">Step 2: Start Optical Flow Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Step-3:-Verify-Services">Step 3: Verify Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Step-4:-Test-Flight">Step 4: Test Flight</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="coordinate_transforms.html">Coordinate Frames</a></li>
<li class="toctree-l1"><a class="reference internal" href="downward_cam_bag.html">Downward Camera Recording + Line Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="detector.html">Custom ROS Message for Line Params</a></li>
<li class="toctree-l1"><a class="reference internal" href="open_loop_translation_control.html">OFFBOARD Mode &amp; Open Loop Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="yaw_color_tracker.html">Yaw-Only Color Tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="line_following.html">Line Following</a></li>
<li class="toctree-l1"><a class="reference internal" href="obstacle_avoidance.html">AR Obstacle Avoidance</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Topics:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="exploring_px4_firmware.html">Exploring PX4 Firmware</a></li>
</ul>
<p class="caption"><span class="caption-text">Supplemental Material:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="team_roles.html">Team Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="safety_checklist.html">Safety Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="Glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Autonomous UAV Racing</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Hovering with Optical Flow</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/enable_optical_flow.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Hovering-with-Optical-Flow">
<h1>Hovering with Optical Flow<a class="headerlink" href="#Hovering-with-Optical-Flow" title="Permalink to this headline">¶</a></h1>
<p>In order for the drone to be capable of autonomous flight it needs some
reference or estimate of it’s position in the world. Outdoors we can use
GPS. Indoors GPS doesn’t work. If we have hundreds of thousands of
dollars and a dedicated flight space, we can use a motion capture system
for position information. Since we don’t assume we have access to such a
facility, we will be using <em>optical flow</em> to get some sense of our
position relative to the position we started.</p>
<p>The theory and algorithms behind optical flow are beyond the scope of
this module. Suffice it to say that optical flow is a way of using a
video stream from an onboard camera in order for the drone to estimate
its velocity which, in turn, can be used to estimate where the drone is
relative to some arbitrary starting point. At this time we are only
concerned with integrating existing libraries and hardware to enable
optical flow on the Intel RTF Drone; any further discussion of the
concepts and theory behind optical flow are left for a later module.</p>
<div class="section" id="Step-1:-Install-Libraries">
<h2>Step 1: Install Libraries<a class="headerlink" href="#Step-1:-Install-Libraries" title="Permalink to this headline">¶</a></h2>
<p>Ensure that you have completed <a class="reference external" href="https://bwsi-uav.github.io/website/initial_setup.html#Step-5:-Optical-Flow-Libraries">these setup
steps</a></p>
<div class="admonition warning">
<p class="admonition-title fa fa-exclamation-circle"><strong>Warning:</strong></p>
<p>At the time of this writing there was an unresolved, intermittent bug
that could cause error messages to spam <code class="docutils literal notranslate"><span class="pre">/var/log/syslog</span></code> so badly
that it threatens to overfill the entire hard drive on the drone. To
ensure this does not happen, check the size of that directory with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">du</span> <span class="o">-</span><span class="n">sh</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span>
</pre></div>
</div>
<p>If at any time in this process that directory it is growing at a more
than a MB every few seconds, shut down the drone and try restarting this
process</p>
</div>
<p>Although they are part of the library install instructions, it is worth
repeating that following parameters need to be set using QGroundControl</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">EKF2_AID_MASK</span></code>: 2</li>
<li><code class="docutils literal notranslate"><span class="pre">EKF2_HGT_MODE</span></code>: 2</li>
<li><code class="docutils literal notranslate"><span class="pre">COM_POS_FS_EPH</span></code>: 50000</li>
</ul>
</div>
<div class="section" id="Step-2:-Start-Optical-Flow-Services">
<h2>Step 2: Start Optical Flow Services<a class="headerlink" href="#Step-2:-Start-Optical-Flow-Services" title="Permalink to this headline">¶</a></h2>
<p>Follow these steps to run the start the optical flow service</p>
<ul class="simple">
<li>Power on remote control</li>
<li>Power on the Intel RTF</li>
<li>Connect to UAV via QGroundControl (need to know IP address from
previous flights or connect a monitor and run <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code>)</li>
<li>SSH into UAV (need to know IP address from previous flights or
connect a monitor and run <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code>)</li>
<li>Start the teraranger and optical flow services</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">aero</span><span class="o">-</span><span class="n">teraranger</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">aero</span><span class="o">-</span><span class="n">optical</span><span class="o">-</span><span class="n">flow</span>
</pre></div>
</div>
</div>
<div class="section" id="Step-3:-Verify-Services">
<h2>Step 3: Verify Services<a class="headerlink" href="#Step-3:-Verify-Services" title="Permalink to this headline">¶</a></h2>
<p>To make sure things are working as expected, run the following steps:</p>
<ul class="simple">
<li>Check that syslog is not being spammed and at risk of filling the
disk. Run the following command and to ensure that this directory is
not growing extremely quickly</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">du</span> <span class="o">-</span><span class="n">sh</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span>
</pre></div>
</div>
<ul class="simple">
<li>Check quality of optical flow in QGroundControl: Widgets -&gt; MAVlink
Inspector -&gt; Vehicle 1 -&gt; OPTICAL_FLOW_RAD -&gt; quality should be
around 100 or more to be comfortable</li>
<li>Check distance sensor is giving reasonable results: QGroundControl:
Widgets -&gt; MAVlink Inspector -&gt; Vehicle 1 -&gt; DISTANCE_SENSOR -&gt;
current_distance. If drone is sitting on the ground, the value should
either be -Inf or equal to min_distance</li>
<li>Make sure your local position estimate is reasonable in
QGroundControl -&gt; Widgets -&gt; Analyze and check the following values:
LOCAL_POSITION_NED.x, LOCAL_POSITION_NED.y, LOCAL_POSITION_NED.z</li>
</ul>
<p>If any of these parameters are not in MAVLink Inspector or Analyze, you
know that something is wrong</p>
</div>
<div class="section" id="Step-4:-Test-Flight">
<h2>Step 4: Test Flight<a class="headerlink" href="#Step-4:-Test-Flight" title="Permalink to this headline">¶</a></h2>
<p>If everything in <a class="reference external" href="#enable_optical_flow-verify_services">step 3</a>
appear to be working correctly, you are ready to try a test flight.</p>
<ul class="simple">
<li>Using the RC, switch to position control before arming</li>
<li>If that works, switch back to manual control, take off, and once
stabilized, switch to position control</li>
<li>If the drone seems to ascend slowly while in position control, drop
the throttle a small amount (it is registering a throttle above the
“hover in place” threshold and thinks you want to ascend). If you
drop the throttle enough, it will land automatically</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="coordinate_transforms.html" class="btn btn-neutral float-right" title="Coordinate Frames" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="internal_sensor_testing.html" class="btn btn-neutral" title="Inspecting Sensor Feeds" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Ross Allen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>