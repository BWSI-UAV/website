

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Line Following &mdash; Autonomous UAV Racing 0.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="AR Obstacle Avoidance" href="obstacle_avoidance.html" />
    <link rel="prev" title="Yaw-Only Color Tracker" href="yaw_color_tracker.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Autonomous UAV Racing
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Course Agenda:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="intro.html">BWSI’s Autonomous UAV Racing</a></li>
<li class="toctree-l1"><a class="reference internal" href="initial_setup.html">Module 0: UAV Environment Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="quadrotor_basics.html">Module 1: Hands-On Quadrotors</a></li>
<li class="toctree-l1"><a class="reference internal" href="computer_vision.html">Module 2: Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="planning_control.html">Module 3: Estimation &amp; Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="racing_challenges.html">Module 4: Racing Challenges</a></li>
</ul>
<p class="caption"><span class="caption-text">Practicals:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="project_workflow.html">Project Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="student_drone_setup.html">Student Drone Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="calibration.html">Calibrating Intel RTF Drones</a></li>
<li class="toctree-l1"><a class="reference internal" href="flight_log_analysis.html">Flight Log Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="intel_rtf_architecture.html">Architecture Concept Review</a></li>
<li class="toctree-l1"><a class="reference internal" href="ros_introduction.html">Intro to ROS</a></li>
<li class="toctree-l1"><a class="reference internal" href="communication_pipeline.html">Communication Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessing_video_streams.html">Accessing Video Streams</a></li>
<li class="toctree-l1"><a class="reference internal" href="internal_sensor_testing.html">Inspecting Sensor Feeds</a></li>
<li class="toctree-l1"><a class="reference internal" href="enable_optical_flow.html">Hovering with Optical Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="coordinate_transforms.html">Coordinate Frames</a></li>
<li class="toctree-l1"><a class="reference internal" href="downward_cam_bag.html">Downward Camera Recording + Line Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="detector.html">Custom ROS Message for Line Params</a></li>
<li class="toctree-l1"><a class="reference internal" href="open_loop_translation_control.html">OFFBOARD Mode &amp; Open Loop Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="yaw_color_tracker.html">Yaw-Only Color Tracker</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Line Following</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Breaking-Down-Line-Following">Breaking Down Line Following</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Computer-Vision-(line_tracker/src/detector.py)">Computer Vision (<code class="docutils literal notranslate"><span class="pre">line_tracker/src/detector.py</span></code>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Control-Systems-(line_tracker/src/tracker.py)">Control Systems (<code class="docutils literal notranslate"><span class="pre">line_tracker/src/tracker.py</span></code>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Preflight-Code-Checkpoint">Preflight Code Checkpoint</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Setup-for-Test-Flight">Setup for Test Flight</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Test-Flight">Test Flight</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="obstacle_avoidance.html">AR Obstacle Avoidance</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Topics:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="exploring_px4_firmware.html">Exploring PX4 Firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="kalman_filters.html">Kalman Filters</a></li>
</ul>
<p class="caption"><span class="caption-text">Supplemental Material:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="team_roles.html">Team Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="safety_checklist.html">Safety Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="Glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Autonomous UAV Racing</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Line Following</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/line_following.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Line-Following">
<h1>Line Following<a class="headerlink" href="#Line-Following" title="Permalink to this headline">¶</a></h1>
<p>In this practical, you will learn how to put together your
parameterization of a line detected from the downward camera with a
flight controller to accurately follow a line.</p>
<p>Key tools:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">opencv</span></code></li>
<li>Closed-loop velocity control</li>
<li><code class="docutils literal notranslate"><span class="pre">rosmsg</span></code></li>
</ul>
<div class="section" id="Breaking-Down-Line-Following">
<h2>Breaking Down Line Following<a class="headerlink" href="#Breaking-Down-Line-Following" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Computer-Vision-(line_tracker/src/detector.py)">
<h3>Computer Vision (<code class="docutils literal notranslate"><span class="pre">line_tracker/src/detector.py</span></code>)<a class="headerlink" href="#Computer-Vision-(line_tracker/src/detector.py)" title="Permalink to this headline">¶</a></h3>
<p>Your computer vision algorithms must be precise and accurate when
detecting the LED strip that will feature in the final race.</p>
<p>Be sure to test your existing CV algorithms by publishing an Image
message on <code class="docutils literal notranslate"><span class="pre">/line/img</span></code> that shows the line being tracked. You will be
testing this on a <code class="docutils literal notranslate"><span class="pre">rosbag</span></code> <strong>before you have the opportunity to fly
your code</strong>. Notify an instructor once you have the proper image
displayed on top of the <code class="docutils literal notranslate"><span class="pre">rosbag</span></code> we have provided you. You will then
be permitted to move on to the next stage of development in this task.</p>
</div>
<div class="section" id="Control-Systems-(line_tracker/src/tracker.py)">
<h3>Control Systems (<code class="docutils literal notranslate"><span class="pre">line_tracker/src/tracker.py</span></code>)<a class="headerlink" href="#Control-Systems-(line_tracker/src/tracker.py)" title="Permalink to this headline">¶</a></h3>
<p>You will be controlling two degrees of freedom in the line following
task: <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span></p>
<p>Using information about the image that the downward camera is
publishing, you will calculate the error between your desired position
on the line and your current position.</p>
<p>This can be broken down into a few steps:</p>
<ul class="simple">
<li>Find the point representing the center of the image
<span class="math notranslate nohighlight">\(p_{frame-center}\)</span>, and the point representing the center of
the line <span class="math notranslate nohighlight">\(p_{line-center}\)</span> (in pixel coordinates)</li>
<li>Find the unit vector in the direction of the line
<span class="math notranslate nohighlight">\(\vec{r}_{line-unit}\)</span> (using <code class="docutils literal notranslate"><span class="pre">vx</span></code> and <code class="docutils literal notranslate"><span class="pre">vy</span></code>)</li>
<li>Find the point on the line closest to the center of the frame
<span class="math notranslate nohighlight">\(p_{line-closest-center}\)</span></li>
<li>Extrapolate a point forward (from <span class="math notranslate nohighlight">\(p_{line-closest-center}\)</span>) on
the line using the unit vector in the direction of the line, making
sure that the unit vector is positive <span class="math notranslate nohighlight">\(p_{target}\)</span></li>
<li>Calculate the vector from the center of the frame to the extrapolated
point (this represents error) <span class="math notranslate nohighlight">\(\vec{r}_{to-target}\)</span></li>
<li>Select safe, appropriate gains for your proportional velocity
controller than enable the drone to change its velocity to track a
the target on the line. Should its response be aggressive? Consider
the pros and cons of aggressive vs non-aggressive control behavior.
Your <span class="math notranslate nohighlight">\(K_{P_x}\)</span> and <span class="math notranslate nohighlight">\(K_{P_y}\)</span> should always start below 1.</li>
<li>Calculate <span class="math notranslate nohighlight">\(v_x(t)\)</span> and <span class="math notranslate nohighlight">\(v_y(t)\)</span> using your pre-determined
<span class="math notranslate nohighlight">\(K_P\)</span> values.</li>
</ul>
<p>Diagram:</p>
<div class="figure" id="id1">
<img alt="line_diagram.jpg" src="https://github.com/BWSI-UAV/website/blob/master/docs/images/line_diagram.jpg?raw=true" />
<p class="caption"><span class="caption-text">line_diagram.jpg</span></p>
</div>
</div>
</div>
<div class="section" id="Preflight-Code-Checkpoint">
<h2>Preflight Code Checkpoint<a class="headerlink" href="#Preflight-Code-Checkpoint" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Graph error vs.&nbsp;time on the provided <code class="docutils literal notranslate"><span class="pre">rosbag</span></code>. An instructor will
check to see that the error graphs are consistent with actual data.
You should use RQT’s built in graph mechanism to view the output of
your error function (publish a Vector3 on <code class="docutils literal notranslate"><span class="pre">/line/error</span></code>).<ul>
<li>You will have to install rqt_common_plugins. Use
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">ros-kinetic-rqt-common-plugins</span></code> followed
by <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">~/.config/ros.org/rqt_gui.ini</span></code></li>
<li>Use “Plot” under Visualization</li>
</ul>
</li>
<li>Output velocity commands to <code class="docutils literal notranslate"><span class="pre">/mavros/setpoint_velocity/cmd_vel</span></code> and
<code class="docutils literal notranslate"><span class="pre">rostopic</span> <span class="pre">echo</span></code> them using the <code class="docutils literal notranslate"><span class="pre">rosbag</span></code>. An instructor will
verify that the velocity commands are successful.</li>
</ul>
<p>After these checkpoints, you will be allowed to fly your code and test
it to tune your <span class="math notranslate nohighlight">\(K_P\)</span> constants.</p>
</div>
<div class="section" id="Setup-for-Test-Flight">
<h2>Setup for Test Flight<a class="headerlink" href="#Setup-for-Test-Flight" title="Permalink to this headline">¶</a></h2>
<p>Once <code class="docutils literal notranslate"><span class="pre">detector.py</span></code> and <code class="docutils literal notranslate"><span class="pre">tracker.py</span></code> have been completed and pulled
onto the drone, run the flight test by following these procedures</p>
<ul>
<li><p class="first">Power on remote control</p>
</li>
<li><p class="first">Power on the Intel RTF</p>
</li>
<li><p class="first">Connect to the UAV via QGroundControl</p>
</li>
<li><p class="first">SSH into the UAV (you will need to have at least four terminals SSHed
into the UAV). use X-forwarding in order to pass graphics
(i.e.&nbsp;stream the camera feed from the drone to your computer).
Example replacing <code class="docutils literal notranslate"><span class="pre">&lt;team-drone-name&gt;</span></code> with the name of your drone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">X</span> <span class="n">uav</span><span class="o">@&lt;</span><span class="n">team</span><span class="o">-</span><span class="n">drone</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;.</span><span class="n">beaver</span><span class="o">.</span><span class="n">works</span>
</pre></div>
</div>
</li>
<li><p class="first">In terminal 1, start distance sensor</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">aero</span><span class="o">-</span><span class="n">teraranger</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</li>
<li><p class="first">In terminal 1, start ROS</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">roscore</span>
</pre></div>
</div>
</li>
<li><p class="first">In terminal 2, start <em>patched</em> optical flow + down-camera streaming.
Note: this is different from <em>standard</em> optical flow service that
prevents streaming downward-facing camera. Needed for line detection.
<a class="reference external" href="https://github.mit.edu/ma23705/aero_downward_ros/blob/master/README.md">See here for more info on setting
up</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">bwsi</span><span class="o">-</span><span class="n">uav</span><span class="o">/</span><span class="n">catkin_ws</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">aero</span><span class="o">-</span><span class="n">optical</span><span class="o">-</span><span class="n">flow</span><span class="o">/</span><span class="n">build</span>
<span class="n">sudo</span> <span class="o">-</span><span class="n">E</span> <span class="o">./</span><span class="n">aero</span><span class="o">-</span><span class="n">optical</span><span class="o">-</span><span class="n">flow</span>
</pre></div>
</div>
</li>
<li><p class="first">Without arming drone, switch to <code class="docutils literal notranslate"><span class="pre">POSITION</span> <span class="pre">CONTROL</span></code> mode to ensure
previous steps worked as expect. If QGroundControl declares that that
position control is rejected, use QGroundControl &gt; Widgets &gt; MAVLink
Inspector to debug and potentially restart process.</p>
</li>
<li><p class="first">In terminal 3, launch <code class="docutils literal notranslate"><span class="pre">mavros</span></code>, <code class="docutils literal notranslate"><span class="pre">detector</span></code>, and <code class="docutils literal notranslate"><span class="pre">tracker</span></code> using
<code class="docutils literal notranslate"><span class="pre">detect_track.launch</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">bwsi</span><span class="o">-</span><span class="n">uav</span><span class="o">/</span><span class="n">catkin_ws</span>
<span class="n">source</span> <span class="n">devel</span><span class="o">/</span><span class="n">setup</span><span class="o">.</span><span class="n">bash</span>
<span class="n">roslaunch</span> <span class="n">aero_control</span> <span class="n">detect_track</span><span class="o">.</span><span class="n">launch</span>
</pre></div>
</div>
</li>
<li><p class="first">(OPTIONAL) In terminal 4, visualize the downward camera feed for line
detection.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rqt_image_view</span>
</pre></div>
</div>
<p>and select <code class="docutils literal notranslate"><span class="pre">/line/detector_image</span></code> from the dropdown menu</p>
</li>
</ul>
</div>
<div class="section" id="Test-Flight">
<h2>Test Flight<a class="headerlink" href="#Test-Flight" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title fa fa-exclamation-circle"><strong>WARNING:</strong></p>
<p>Pilot-in-Command must always be ready to regain control by switching
back to <code class="docutils literal notranslate"><span class="pre">POSCTL</span></code> mode. Never take your hands off the remote control!</p>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">POSITION</span> <span class="pre">CONTROL</span></code> mode</p>
<ol class="arabic simple">
<li>Arm the quadrotor</li>
<li>Takeoff</li>
<li>Position in a safe location in the air</li>
<li>Switch to <code class="docutils literal notranslate"><span class="pre">OFFBOARD</span></code> mode to run test</li>
<li>Regain control with <code class="docutils literal notranslate"><span class="pre">POSITION</span></code> mode</li>
<li>Land quadrotor</li>
<li>Disarm</li>
<li>Collect <a class="reference external" href="flight_log_analysis.html">flight log</a></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="obstacle_avoidance.html" class="btn btn-neutral float-right" title="AR Obstacle Avoidance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="yaw_color_tracker.html" class="btn btn-neutral" title="Yaw-Only Color Tracker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Ross Allen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>